<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance System - Firebase Only</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
</head>
<body>
    <div id="app">
        <!-- Loading Screen -->
        <div id="loading-screen">
            <div class="spinner"></div>
            <p>Loading Attendance System...</p>
        </div>

        <!-- Login Section -->
        <div id="login-section" style="display:none;">
            <h2>Attendance System Login</h2>
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" placeholder="Enter your email" required>
            </div>
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" placeholder="Enter your password" required>
            </div>
            <div class="button-group">
                <button onclick="login()" class="btn-primary">Login</button>
                <button onclick="register()" class="btn-secondary">Register</button>
            </div>
            <div id="auth-error" class="error-message"></div>
        </div>
        
        <!-- Admin Dashboard -->
        <div id="admin-section" style="display:none;">
            <div class="dashboard-header">
                <h2>Attendance Management System</h2>
                <div class="user-info">
                    <span>Welcome, <strong id="current-user"></strong></span>
                    <button onclick="logout()" class="btn-logout">Logout</button>
                </div>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('attendance')">Take Attendance</button>
                <button class="tab-btn" onclick="switchTab('students')">Manage Students</button>
                <button class="tab-btn" onclick="switchTab('reports')">Reports</button>
            </div>

            <!-- Take Attendance Tab -->
            <div id="attendance-tab" class="tab-content">
                <div class="controls">
                    <div class="control-group">
                        <label>Date:</label>
                        <input type="date" id="attendance-date" value="">
                    </div>
                    <div class="control-group">
                        <label>Class:</label>
                        <select id="class-select">
                            <option value="">Select Class</option>
                            <option value="math101">Math 101</option>
                            <option value="science101">Science 101</option>
                            <option value="english101">English 101</option>
                            <option value="history101">History 101</option>
                        </select>
                    </div>
                    <button onclick="loadStudentsForAttendance()" class="btn-primary">Load Students</button>
                </div>
                
                <div id="attendance-student-list">
                    <!-- Student list will be populated here -->
                </div>
                
                <button onclick="saveAttendance()" class="btn-save">Save Attendance</button>
            </div>

            <!-- Manage Students Tab -->
            <div id="students-tab" class="tab-content" style="display:none;">
                <div class="controls">
                    <div class="control-group">
                        <label>Class:</label>
                        <select id="manage-class-select">
                            <option value="">Select Class</option>
                            <option value="math101">Math 101</option>
                            <option value="science101">Science 101</option>
                            <option value="english101">English 101</option>
                            <option value="history101">History 101</option>
                        </select>
                    </div>
                    <button onclick="loadStudents()" class="btn-primary">Load Students</button>
                </div>

                <div class="student-form">
                    <h3>Add New Student</h3>
                    <input type="text" id="student-name" placeholder="Student Name" required>
                    <input type="text" id="student-id" placeholder="Student ID" required>
                    <select id="student-class">
                        <option value="">Select Class</option>
                        <option value="math101">Math 101</option>
                        <option value="science101">Science 101</option>
                        <option value="english101">English 101</option>
                        <option value="history101">History 101</option>
                    </select>
                    <button onclick="addStudent()" class="btn-primary">Add Student</button>
                </div>

                <div id="student-list">
                    <!-- Students will be listed here -->
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports-tab" class="tab-content" style="display:none;">
                <div class="controls">
                    <div class="control-group">
                        <label>Class:</label>
                        <select id="report-class-select">
                            <option value="">Select Class</option>
                            <option value="math101">Math 101</option>
                            <option value="science101">Science 101</option>
                            <option value="english101">English 101</option>
                            <option value="history101">History 101</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Start Date:</label>
                        <input type="date" id="start-date">
                    </div>
                    <div class="control-group">
                        <label>End Date:</label>
                        <input type="date" id="end-date">
                    </div>
                    <button onclick="generateReport()" class="btn-primary">Generate Report</button>
                </div>

                <div id="reports-container">
                    <!-- Reports will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration - REPLACE WITH YOUR OWN CONFIG
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY_HERE",
            authDomain: "YOUR_PROJECT_ID_HERE.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID_HERE",
            storageBucket: "YOUR_PROJECT_ID_HERE.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID_HERE",
            appId: "YOUR_APP_ID_HERE"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Global variables
        let currentStudents = [];
        let currentAttendance = {};

        // Initialize application
        document.addEventListener('DOMContentLoaded', initializeApp);

        function initializeApp() {
            // Hide loading screen and show login
            setTimeout(() => {
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('login-section').style.display = 'block';
            }, 1000);

            // Check if user is already logged in
            auth.onAuthStateChanged((user) => {
                if (user) {
                    console.log('User is signed in:', user.email);
                    showAdminSection(user);
                } else {
                    console.log('No user is signed in');
                    document.getElementById('login-section').style.display = 'block';
                    document.getElementById('admin-section').style.display = 'none';
                }
            });

            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            if (document.getElementById('attendance-date')) {
                document.getElementById('attendance-date').value = today;
            }
            if (document.getElementById('start-date')) {
                document.getElementById('start-date').value = yesterday;
            }
            if (document.getElementById('end-date')) {
                document.getElementById('end-date').value = today;
            }
        }

        // Authentication Functions
        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('auth-error');
            
            errorDiv.textContent = '';
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    console.log('User signed in:', userCredential.user.email);
                    showAdminSection(userCredential.user);
                })
                .catch((error) => {
                    console.error('Login error:', error.code, error.message);
                    errorDiv.textContent = 'Login failed: ' + error.message;
                });
        }

        function register() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('auth-error');
            
            errorDiv.textContent = '';
            
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    console.log('User registered:', userCredential.user.email);
                    showAdminSection(userCredential.user);
                })
                .catch((error) => {
                    console.error('Registration error:', error.code, error.message);
                    errorDiv.textContent = 'Registration failed: ' + error.message;
                });
        }

        function logout() {
            auth.signOut()
                .then(() => {
                    console.log('User signed out');
                    document.getElementById('login-section').style.display = 'block';
                    document.getElementById('admin-section').style.display = 'none';
                })
                .catch((error) => {
                    console.error('Logout error:', error.message);
                });
        }

        function showAdminSection(user) {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('admin-section').style.display = 'block';
            document.getElementById('current-user').textContent = user.email;
        }

        // Tab Management
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab and activate button
            document.getElementById(`${tabName}-tab`).style.display = 'block';
            event.target.classList.add('active');
        }

        // Attendance Functions
        async function loadStudentsForAttendance() {
            const classSelect = document.getElementById('class-select');
            const selectedClass = classSelect.value;
            
            if (!selectedClass) {
                alert('Please select a class');
                return;
            }

            try {
                const querySnapshot = await db.collection('students')
                    .where('class', '==', selectedClass)
                    .orderBy('name')
                    .get();
                
                currentStudents = [];
                const studentList = document.getElementById('attendance-student-list');
                studentList.innerHTML = '<h3>Students for ' + selectedClass.toUpperCase() + '</h3>';

                querySnapshot.forEach((doc) => {
                    const student = { id: doc.id, ...doc.data() };
                    currentStudents.push(student);
                    addStudentToAttendanceUI(student);
                });

                console.log('Students loaded:', currentStudents.length);
            } catch (error) {
                console.error('Error loading students:', error);
                alert('Error loading students: ' + error.message);
            }
        }

        function addStudentToAttendanceUI(student) {
            const studentList = document.getElementById('attendance-student-list');
            
            const studentDiv = document.createElement('div');
            studentDiv.className = 'student-item';
            studentDiv.innerHTML = `
                <div class="student-info">
                    <strong>${student.name}</strong>
                    <span class="student-id">${student.id}</span>
                </div>
                <div class="status-buttons">
                    <button class="status-btn present" onclick="setStudentStatus('${student.id}', 'present')" data-student="${student.id}">Present</button>
                    <button class="status-btn absent" onclick="setStudentStatus('${student.id}', 'absent')" data-student="${student.id}">Absent</button>
                    <button class="status-btn late" onclick="setStudentStatus('${student.id}', 'late')" data-student="${student.id}">Late</button>
                </div>
            `;
            
            studentList.appendChild(studentDiv);
        }

        function setStudentStatus(studentId, status) {
            // Remove previous active state for this student
            const buttons = document.querySelectorAll(`[data-student="${studentId}"]`);
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // Mark clicked button as active
            event.target.classList.add('active');
            
            // Store the status for this student
            currentAttendance[studentId] = status;
        }

        async function saveAttendance() {
            const attendanceDate = document.getElementById('attendance-date').value;
            const classSelect = document.getElementById('class-select');
            const selectedClass = classSelect.value;

            if (!attendanceDate || !selectedClass) {
                alert('Please select date and class');
                return;
            }

            if (Object.keys(currentAttendance).length === 0) {
                alert('Please mark attendance for at least one student');
                return;
            }

            try {
                const batch = db.batch();

                for (const [studentId, status] of Object.entries(currentAttendance)) {
                    const student = currentStudents.find(s => s.id === studentId);
                    if (student) {
                        const attendanceRef = db.collection('attendance').doc();
                        batch.set(attendanceRef, {
                            studentId: studentId,
                            studentName: student.name,
                            status: status,
                            date: attendanceDate,
                            class: selectedClass,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                }

                await batch.commit();
                alert(`Attendance saved for ${Object.keys(currentAttendance).length} students!`);
                
                // Clear the student list and attendance data after saving
                document.getElementById('attendance-student-list').innerHTML = '';
                currentStudents = [];
                currentAttendance = {};
            } catch (error) {
                console.error('Error saving attendance:', error);
                alert('Error saving attendance: ' + error.message);
            }
        }

        // Student Management Functions
        async function loadStudents() {
            const classSelect = document.getElementById('manage-class-select');
            const selectedClass = classSelect.value;
            
            if (!selectedClass) {
                alert('Please select a class');
                return;
            }

            try {
                const querySnapshot = await db.collection('students')
                    .where('class', '==', selectedClass)
                    .orderBy('name')
                    .get();
                
                const studentList = document.getElementById('student-list');
                studentList.innerHTML = '<h3>Students in ' + selectedClass.toUpperCase() + '</h3>';

                querySnapshot.forEach((doc) => {
                    const student = { id: doc.id, ...doc.data() };
                    addStudentToList(student);
                });

                console.log('Students loaded:', querySnapshot.size);
            } catch (error) {
                console.error('Error loading students:', error);
                alert('Error loading students: ' + error.message);
            }
        }

        function addStudentToList(student) {
            const studentList = document.getElementById('student-list');
            
            const studentDiv = document.createElement('div');
            studentDiv.className = 'student-list-item';
            studentDiv.innerHTML = `
                <div class="student-info">
                    <strong>${student.name}</strong>
                    <span class="student-id">${student.id}</span>
                </div>
                <div class="student-actions">
                    <button onclick="deleteStudent('${student.id}')" class="btn-delete">Delete</button>
                </div>
            `;
            
            studentList.appendChild(studentDiv);
        }

        async function addStudent() {
            const name = document.getElementById('student-name').value.trim();
            const id = document.getElementById('student-id').value.trim();
            const className = document.getElementById('student-class').value;

            if (!name || !id || !className) {
                alert('Please fill in all fields');
                return;
            }

            try {
                await db.collection('students').add({
                    name: name,
                    id: id,
                    class: className,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert('Student added successfully!');
                
                // Clear form
                document.getElementById('student-name').value = '';
                document.getElementById('student-id').value = '';
                document.getElementById('student-class').value = '';

                // Reload students if on the same class
                const currentClass = document.getElementById('manage-class-select').value;
                if (currentClass === className) {
                    loadStudents();
                }
            } catch (error) {
                console.error('Error adding student:', error);
                alert('Error adding student: ' + error.message);
            }
        }

        async function deleteStudent(studentId) {
            if (!confirm('Are you sure you want to delete this student?')) {
                return;
            }

            try {
                await db.collection('students').doc(studentId).delete();
                alert('Student deleted successfully!');
                
                // Reload students
                const currentClass = document.getElementById('manage-class-select').value;
                if (currentClass) {
                    loadStudents();
                }
            } catch (error) {
                console.error('Error deleting student:', error);
                alert('Error deleting student: ' + error.message);
            }
        }

        // Reports Functions
        async function generateReport() {
            const classSelect = document.getElementById('report-class-select');
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const selectedClass = classSelect.value;

            if (!selectedClass || !startDate || !endDate) {
                alert('Please select class and date range');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                alert('Start date cannot be after end date');
                return;
            }

            try {
                const attendanceQuery = await db.collection('attendance')
                    .where('class', '==', selectedClass)
                    .where('date', '>=', startDate)
                    .where('date', '<=', endDate)
                    .get();

                const attendanceData = {};
                attendanceQuery.forEach(doc => {
                    const data = doc.data();
                    if (!attendanceData[data.studentId]) {
                        attendanceData[data.studentId] = {
                            name: data.studentName,
                            present: 0,
                            absent: 0,
                            late: 0,
                            total: 0
                        };
                    }
                    
                    attendanceData[data.studentId][data.status]++;
                    attendanceData[data.studentId].total++;
                });

                displayReport(attendanceData, startDate, endDate);
            } catch (error) {
                console.error('Error generating report:', error);
                alert('Error generating report: ' + error.message);
            }
        }

        function displayReport(attendanceData, startDate, endDate) {
            const container = document.getElementById('reports-container');
            let html = `<h3>Attendance Report (${startDate} to ${endDate})</h3>`;
            
            html += '<table class="report-table">';
            html += '<thead><tr><th>Student</th><th>Present</th><th>Absent</th><th>Late</th><th>Total</th><th>Attendance %</th></tr></thead>';
            html += '<tbody>';

            for (const [studentId, data] of Object.entries(attendanceData)) {
                const percentage = Math.round((data.present / data.total) * 100);
                html += `<tr>
                    <td>${data.name}</td>
                    <td>${data.present}</td>
                    <td>${data.absent}</td>
                    <td>${data.late}</td>
                    <td>${data.total}</td>
                    <td>${percentage}%</td>
                </tr>`;
            }

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Utility functions
        function getCurrentDateTime() {
            return new Date().toISOString();
        }

        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }
    </script>
</body>
</html>